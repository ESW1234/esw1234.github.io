window.esw.defineFeature("Chasitor",function(i){var t=/get[A-Z][A-Za-z0-9_]*/;function B(){this.esw=i;this.liveAgentChasitor=undefined;this.events=undefined;this.chasitorSettings=undefined;this.prechatFormDetails=undefined;this.prechatEntities=undefined;this.chatWindowStateName=undefined;this.registerMessageHandlers();i.loadFeatureScript("FileTransfer");}B.prototype.registerMessageHandlers=function n(){i.addMessageHandler("chasitor.load",this.loadChasitor.bind(this));i.addMessageHandler("chasitor.sendMessage",function(F,E){this.sendMessage(E);}.bind(this));i.addMessageHandler("chasitor.sendRichMessage",function(F,E){this.sendRichMessage(E);}.bind(this));i.addMessageHandler("chasitor.cancelChat",function(){this.cancelChat();}.bind(this));i.addMessageHandler("chasitor.endChat",function(){this.endChat();}.bind(this));i.addMessageHandler("chasitor.abortConnection",function(){this.abortConnection();}.bind(this));i.addMessageHandler("chasitor.sendSneakPeekOrTypingUpdate",function(F,E){this.sendSneakPeekOrTypingUpdate(E);}.bind(this));i.addMessageHandler("chasitor.saveChat",function(){this.saveChat();}.bind(this));i.addMessageHandler("chasitor.updateChatWindowState",function(F,E){this.updateChatWindowState(E);}.bind(this));i.addMessageHandler("chasitor.removeEventListeners",function(){this.removeEventListeners();}.bind(this));i.addMessageHandler("chasitor.stopChasitorIdleTimeout",function(){this.stopChasitorIdleTimeout();}.bind(this));};B.prototype.setChasitorData=function w(F,E){this.domain=F;this.chasitorSettings=E.settingsObj;this.hasOnlyExtraPrechatInfo=E.hasOnlyExtraPrechatInfo;this.prechatFormDetails=E.prechatFormDetails;this.prechatEntities=E.prechatEntities;};B.prototype.createScriptElement=function k(){var E=document.createElement("script");E.id="chasitorScript";E.type="text/javascript";E.onload=function(){this.chasitorInit();}.bind(this);E.src=this.chasitorSettings.chasitorSrc;document.getElementsByTagName("head")[0].appendChild(E);};B.prototype.serializeChat=function d(){var E;var F;if(!this.liveAgentChasitor.isChatEnded()&&(this.liveAgentChasitor.isChatRequestSuccessful()||this.liveAgentChasitor.isChatEngaged())){E=this.liveAgentChasitor.serialize();F=JSON.parse(E);F.chasitorData.isChatEstablished=this.chatWindowStateName==="Chat";i.sessionAPI.setSessionData(this.domain,{CHASITOR_SERIALIZED_KEY:JSON.stringify(F)});}};B.prototype.handleLiveAgentChasitorEvent=function j(F,G){var E=G;if(typeof G==="object"){E={};Object.getOwnPropertyNames(G).forEach(function(H){if(typeof G[H]==="function"&&t.test(H)){E[H]=G[H]();}else{E[H]=G[H];}});}else{E=G;}parent.postMessage({method:"liveagent.event",data:{event:F,params:E,chasitorData:this.gatherChasitorSessionData()}},i.parentOrigin);};B.prototype.registerEvents=function h(){if(this.events){Object.keys(this.events).forEach(function(E){var F=this.events[E];this.liveAgentChasitor.addEventListener(F,this.handleLiveAgentChasitorEvent.bind(this,F),"ESW_"+F);}.bind(this));}};B.prototype.passPrechatDataToLiveAgent=function A(){if(this.prechatFormDetails===undefined||!this.prechatFormDetails.length){return;}this.prechatFormDetails.forEach(function(G){var H=G.value;var E=G.transcriptFields;var F;if(typeof H==="string"){H=G.value.trim();}F=this.liveAgentChasitor.addCustomDetail(G.label,H,G.displayToAgent);if(E){E.forEach(F.addTranscriptField);}if(G.name==="FirstName"){this.liveAgentChasitor.setName(H);this.liveAgentChasitor.setLocalName(H);}}.bind(this));this.liveAgentChasitor.addCustomDetail("eswLiveAgentDevName",this.chasitorSettings.eswLiveAgentDevName,false);this.liveAgentChasitor.addCustomDetail("hasOnlyExtraPrechatInfo",this.hasOnlyExtraPrechatInfo,false);this.prechatEntities.forEach(function(F){var E;this.liveAgentChasitor.addEntity(F.entityName,F.showOnCreate,F.linkToEntityName,F.linkToEntityField,F.saveToTranscript);E=F.entityFieldMaps;E.forEach(function(G){this.liveAgentChasitor.addEntityFieldsMap(F.entityName,G.fieldName,G.label,G.doFind,G.isExactMatch,G.doCreate);}.bind(this));}.bind(this));};B.prototype.passCustomDetailsToLiveAgent=function a(){if(this.chasitorSettings.hasOwnProperty("chatbotVersion")&&this.chasitorSettings.chatbotVersion){this.liveAgentChasitor.addCustomDetail("chatbotVersion",this.chasitorSettings.chatbotVersion,false);}};B.prototype.isNewChatSession=function u(){return !i.sessionAPI.getSessionData(this.domain,["CHASITOR_SERIALIZED_KEY"]).CHASITOR_SERIALIZED_KEY;};B.prototype.gatherChasitorSessionData=function D(){return{chasitorSettings:this.chasitorSettings,acceptTime:this.liveAgentChasitor.getAcceptTime(),requestTime:this.liveAgentChasitor.getRequestTime(),oref:this.liveAgentChasitor.getOref(),chatKey:this.liveAgentChasitor.getChatKey(),connectionSessionId:this.liveAgentChasitor.getConnectionSessionId(),details:this.liveAgentChasitor.getDetails(),name:this.liveAgentChasitor.getName(),chatMessages:this.getChatMessages(),isSneakPeekEnabled:this.liveAgentChasitor.isSneakPeekEnabled(),isAgentTyping:this.liveAgentChasitor.isAgentTyping(),isFileRequested:this.liveAgentChasitor.isFileRequested(),isChatEstablished:this.liveAgentChasitor.isChatEstablished(),isChatEngaged:this.liveAgentChasitor.isChatEngaged(),isChatEnded:this.liveAgentChasitor.isChatEnded(),isChatTransferredToQueue:this.liveAgentChasitor.isChatTransferredToQueue(),isChatRequestSuccessful:this.liveAgentChasitor.isChatRequestSuccessful(),orgId:this.liveAgentChasitor.getOrgId(),language:this.liveAgentChasitor.getLanguage(),lastUrl:this.liveAgentChasitor.getLastUrl(),transcriptSaveEnabled:this.liveAgentChasitor.getTranscriptSaveEnabled()};};B.prototype.getChatMessages=function z(){var E=this.liveAgentChasitor.getChatMessages();var F=[];E.forEach(function(G){var H={};Object.getOwnPropertyNames(G).forEach(function(I){if(typeof G[I]==="function"&&t.test(I)){H[I]=G[I]();}});F.push(H);});return F;};B.prototype.initializeChasitor=function e(){var G="snapins";var E=this.chasitorSettings.endpointURL;var H=this.chasitorSettings.contentServerURL;var F=this.chasitorSettings.visitorInfo;this.liveAgentChasitor.resetChasitorState();this.liveAgentChasitor.setOrgId(this.chasitorSettings.orgId);this.liveAgentChasitor.setDeploymentId(this.chasitorSettings.deploymentId);this.liveAgentChasitor.setButtonId(this.chasitorSettings.buttonId);this.passPrechatDataToLiveAgent();this.passCustomDetailsToLiveAgent();this.liveAgentChasitor.setVisitorInfo(F.visitCount,F.originalReferrer,F.pages);this.liveAgentChasitor.init(E,H,[],false);this.liveAgentChasitor.startChat(G);parent.postMessage({method:"liveagent.initialized",data:{chasitorEvents:this.events,chasitorSessionData:this.gatherChasitorSessionData()}},i.parentOrigin);};B.prototype.restoreSession=function y(){this.liveAgentChasitor.deserialize(i.sessionAPI.getSessionData(this.domain,["CHASITOR_SERIALIZED_KEY"]).CHASITOR_SERIALIZED_KEY);this.liveAgentChasitor.init(this.chasitorSettings.endpointURL,this.chasitorSettings.contentServerURL,[],false);this.liveAgentChasitor.reinitializeSession();this.liveAgentChasitor.restoreChasitorIdleTimeout();parent.postMessage({method:"liveagent.restored",data:{chasitorEvents:this.events,chasitorSessionData:this.gatherChasitorSessionData()}},i.parentOrigin);};B.prototype.chasitorInit=function g(){this.liveAgentChasitor=window.liveagent.chasitor;Object.defineProperty(this,"events",{get:function(){return this.liveAgentChasitor.Events;}.bind(this)});this.registerEvents();this.liveAgentChasitor.onMutate=function(){this.serializeChat();}.bind(this);this.startChatSession();};B.prototype.startChatSession=function s(){if(this.isNewChatSession()){this.initializeChasitor();}else{this.restoreSession();}};B.prototype.sendMessage=function c(E){this.liveAgentChasitor.sendMessage(E);};B.prototype.sendRichMessage=function p(E){this.liveAgentChasitor.sendSnapInRichMessage(E);};B.prototype.cancelChat=function v(){this.liveAgentChasitor.cancelChat();this.esw.sessionAPI.deleteSessionData(this.domain,["CHASITOR_SERIALIZED_KEY"]);};B.prototype.endChat=function r(){this.liveAgentChasitor.endChat();this.esw.sessionAPI.deleteSessionData(this.domain,["CHASITOR_SERIALIZED_KEY"]);};B.prototype.loadChasitor=function x(G,F){var E=document.getElementById("chasitorScript");this.setChasitorData(G,F);if(E){E.parentNode.removeChild(E);[].slice.apply(document.querySelectorAll("iframe")).forEach(function(I){var H=I.getAttribute("src");if(H&&H.indexOf("cdm")!==-1){I.parentNode.removeChild(I);}});this.removeEventListeners();}this.createScriptElement();};B.prototype.sendSneakPeekOrTypingUpdate=function f(E){if(this.liveAgentChasitor.isSneakPeekEnabled()){this.liveAgentChasitor.sendSneakPeek(E);}else{this.liveAgentChasitor.sendTypingUpdate(E.length);}};B.prototype.saveChat=function m(){var H="";var G=[];var E=[];var F=[];if(/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream){this.liveAgentChasitor.getChatMessages().forEach(function(I){G.push(I.getName());E.push(I.getTimestamp());F.push(I.getContent());});H=JSON.stringify({names:G,timestamps:E,messages:F});i.postMessage("liveagent.saveChatIOSCallback",{chasitorData:this.gatherChasitorSessionData(),textLog:H});}else{this.liveAgentChasitor.saveChat();}};B.prototype.abortConnection=function b(){this.liveAgentChasitor.abortConnection();};B.prototype.serialize=function q(){this.liveAgentChasitor.serialize();};B.prototype.removeEventListeners=function o(){window.liveagent.removeEventListeners();};B.prototype.updateChatWindowState=function C(E){this.chatWindowStateName=E;this.serializeChat();};B.prototype.stopChasitorIdleTimeout=function l(){this.liveAgentChasitor.stopChasitorIdleTimeout();};i.chasitorAPI=new B();});