embedded_svc.defineFeature("LiveAgent",function(esw){var VISITOR_INFO_KEY="LA_VISITOR_INFO";var AVAILABILITY_PING_TIMEOUT=5000;var AVAILABILITY_PING_RATE=50000;var SCRT_API_VERSION=36;var INVITE_DOM_ID="snapins_invite";function Noun(name,data){this.name=name;this.data=data;}function SCRTConnection(liveAgentApi){this.liveAgentAPI=liveAgentApi;this.running=false;this.pingTimeoutTimer=undefined;this.pingScript=undefined;this.sid=esw.getCookie("liveagent_sid");}SCRTConnection.prototype.send=function send(nouns,params){var paramData=params||{};var prefix="Visitor";var noun="";var isMultinoun=false;var url;var scriptElem;if(this.pingScript){this.onError("SCRT did not handle response before sending another message.");return;}if(nouns.length>1){prefix="System";noun="MultiNoun";paramData.nouns="";isMultinoun=true;}else{noun=nouns[0].name;}url=esw.settings.baseLiveAgentURL+"/rest/"+prefix+"/"+noun+".jsonp?";nouns.forEach(function(nounItem){if(isMultinoun){paramData.nouns+=nounItem.name+",";}paramData[nounItem.name+".prefix"]="Visitor";Object.getOwnPropertyNames(nounItem.data).forEach(function(property){paramData[nounItem.name+"."+property]=nounItem.data[property];});});if(isMultinoun){paramData.nouns=paramData.nouns.substr(0,paramData.nouns.length-1);}Object.getOwnPropertyNames(paramData).forEach(function(paramKey){url+=paramKey+"="+paramData[paramKey]+"&";});url+="callback=embedded_svc.liveAgentAPI.connection.handlePing"+"&deployment_id="+esw.settings.deploymentId+"&org_id="+esw.settings.orgId+"&version="+SCRT_API_VERSION;scriptElem=document.createElement("script");scriptElem.type="text/javascript";scriptElem.src=url;this.pingScript=document.body.appendChild(scriptElem);this.pingTimeoutTimer=window.setTimeout(function(){this.onError("Server failed to respond.");}.bind(this),AVAILABILITY_PING_TIMEOUT);};SCRTConnection.prototype.handlePing=function handlePing(data){if(this.pingTimeoutTimer){clearTimeout(this.pingTimeoutTimer);this.pingTimeoutTimer=undefined;}this.running=true;data.messages.forEach(function(message){this.messageHandler(message.type,message.message);}.bind(this));this.onSuccess();if(this.pingScript){document.body.removeChild(this.pingScript);this.pingScript=undefined;}};SCRTConnection.prototype.messageHandler=function messageHandler(type,message){switch(type){case"Availability":this.liveAgentAPI.handleAvailability(message);break;case"SwitchServer":this.liveAgentAPI.handleSwitchServer(message);break;case"Settings":this.liveAgentAPI.handleSettings(message);break;default:esw.log("Unexpected message of type "+type+": "+JSON.stringify(message));}};SCRTConnection.prototype.onSuccess=function onSuccess(nextPingTimeout){var timeout=nextPingTimeout||AVAILABILITY_PING_RATE;if(this.pingTimer){clearTimeout(this.pingTimer);}this.pingTimer=window.setTimeout(this.liveAgentAPI.ping.bind(this.liveAgentAPI),timeout);};SCRTConnection.prototype.onError=function onError(message){esw.error(message);};function VisitorInfo(){this.visitCount=0;this.originalReferrer=undefined;this.pages=[];}VisitorInfo.prototype.initialize=function initialize(serializedData){var parsedVisitorInfo;if(serializedData&&serializedData[VISITOR_INFO_KEY]){parsedVisitorInfo=JSON.parse(serializedData[VISITOR_INFO_KEY]);this.visitCount=parsedVisitorInfo.visitCount;this.originalReferrer=parsedVisitorInfo.originalReferrer;this.pages=parsedVisitorInfo.pages;}else{this.originalReferrer=document.referrer;}this.visitCount+=1;this.addCurrentPage();this.serialize();};VisitorInfo.prototype.serialize=function serialize(){var visitorInfoJSON=JSON.stringify({visitCount:this.visitCount,originalReferrer:this.originalReferrer,pages:this.pages});if(embedded_svc){embedded_svc.setSessionData(VISITOR_INFO_KEY,visitorInfoJSON);}else{window.sessionStorage.setItem(VISITOR_INFO_KEY,visitorInfoJSON);}};VisitorInfo.prototype.getInfo=function getInfo(){return{visitCount:this.visitCount,originalReferrer:this.originalReferrer,pages:this.pages};};VisitorInfo.prototype.addCurrentPage=function addCurrentPage(){var currentPage=window.location.href;this.pages.forEach(function(page,index){if(page.location===currentPage){this.pages.splice(index,1);}}.bind(this));this.pages.unshift({location:currentPage,time:(new Date()).getTime()});};function LiveAgentAPI(){this.connection=new SCRTConnection(this);this.visitorInfo=new VisitorInfo();esw.loadFeatureScript("Invite",function(){embedded_svc.liveAgentAPI.getButtonSettings();});esw.setDefaultButtonText("LiveAgent","Chat with an Expert","Agent Offline");esw.addDefaultSetting("avatarImgURL","");esw.addDefaultSetting("prechatBackgroundImgURL","");esw.addDefaultSetting("waitingStateBackgroundImgURL","");esw.addDefaultSetting("smallCompanyLogoImgURL","");esw.addDefaultSetting("headerBackgroundURL","");esw.addDefaultSetting("extraPrechatInfo",[]);esw.addDefaultSetting("extraPrechatFormDetails",[]);esw.addEventHandler("error",this.disconnect.bind(this));esw.addEventHandler("sessionDataRetrieved",function(serializedData){this.ping();this.visitorInfo.initialize(serializedData);return !!serializedData.CHASITOR_SERIALIZED_KEY;}.bind(this));esw.addEventHandler("beforeCreate",function(){esw.settings.visitorInfo=this.visitorInfo.getInfo();}.bind(this));esw.addEventHandler("validateInit",function(settings){if(typeof settings.baseLiveAgentURL!=="string"){throw new Error("Invalid Live Agent chat URL: "+settings.baseLiveAgentURL);}if(typeof settings.baseLiveAgentContentURL!=="string"){throw new Error("Invalid Live Agent content URL: "+settings.baseLiveAgentContentURL);}if(!this.isButtonId(settings.buttonId)){throw new Error("Invalid ButtonId Parameter Value: "+settings.buttonId);}if(!this.isDeploymentId(settings.deploymentId)){throw new Error("Invalid DeploymentId Parameter Value: "+settings.deploymentId);}return true;}.bind(this));esw.loadStorageScript("Chasitor");esw.addMessageHandler("liveagent.fileTransfer.recieveFileTransfer",function(data){this.sendFileInfo(data);}.bind(this));esw.registerStorageKeys(["CHASITOR_SERIALIZED_KEY","LA_ESW_UNREAD_NOTIFICATIONS","LA_ESW_CHAT_SCROLL_POSITION","LA_ESW_UNSEEN_MESSAGES","LA_VISITOR_INFO","LA_ESW_FILE_TOKEN","LA_ESW_FILE_UPLOAD_SERVLET_URL"]);if(esw.settings.entryFeature==="LiveAgent"){esw.isButtonDisabled=true;}}LiveAgentAPI.prototype.ping=function ping(){var params={};var nouns=[new Noun("Availability",{ids:"["+esw.settings.buttonId+"]"})];esw.log("Pinging server");this.connection.pingTimer=undefined;params.sid=this.sid;params.r=new Date().getMilliseconds();this.connection.send(nouns,params);};function jsonDecode(str){var escape=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g;var returnStr=String(str);if(typeof window.JSON!=="undefined"){return window.JSON.parse(returnStr);}escape.lastIndex=0;if(escape.test(str)){returnStr=returnStr.replace(escape,function(match){return"\\u"+("0000"+match.charCodeAt(0).toString(16)).slice(-4);});}if(/^[\],:{}\s]*$/.test(str.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))){return eval("("+returnStr+")");}throw new Error("Error during JSON.parse");}LiveAgentAPI.prototype.getButtonSettings=function getButtonSettings(){var nouns=[];var params={};if(this.sid){params.sid=this.sid;params.r=new Date().getMilliseconds();esw.log("Reusing existing session.");}nouns.push(new Noun("Settings",{buttonIds:"["+esw.settings.buttonId+"]",updateBreadcrumb:1}));this.connection.send(nouns,params);};LiveAgentAPI.prototype.handleAvailability=function handleAvailability(message){esw.log("Agent Available: "+JSON.stringify(message));message.results.forEach(function(result){var agentAvailable=result.isAvailable;if(esw.settings.entryFeature==="LiveAgent"){esw.isButtonDisabled=!agentAvailable;if(esw.inviteAPI&&esw.inviteAPI.inviteButton.getTracker()){esw.inviteAPI.inviteButton.setOnlineState(agentAvailable);}}});};function handleInviteButton(data){var inviteElement;var inviteRules=jsonDecode(data.inviteRules);inviteElement=document.getElementById(INVITE_DOM_ID);if(inviteElement&&esw.inviteAPI&&data.inviteRenderer!=="Custom"){esw.inviteAPI.inviteButton.addTracker(inviteElement,data);esw.inviteAPI.inviteButton.setRules(inviteRules.rules,inviteRules.filter);esw.inviteAPI.inviteButton.setOnlineState(data.isAvailable);}}LiveAgentAPI.prototype.handleSettings=function handleSettings(message){message.buttons.forEach(function(button){if(button.type==="Invite"&&button.id===esw.settings.buttonId){handleInviteButton(button);}});};LiveAgentAPI.prototype.handleSwitchServer=function handleSwitchServer(message){var newChatServerUrl=message.newUrl;esw.log("Detected new Live Agent url: "+newChatServerUrl);esw.settings.baseLiveAgentURL=newChatServerUrl;esw.log("Immediately re-pinging server with new Live Agent url");window.setTimeout(function(){this.connection.onSuccess(1);}.bind(this),1);this.getButtonSettings();};LiveAgentAPI.prototype.disconnect=function disconnect(){esw.log("Disconnecting from Live Agent");this.connection.running=false;};LiveAgentAPI.prototype.isButtonId=function isButtonId(entityId){return esw.getKeyPrefix(entityId)==="573";};LiveAgentAPI.prototype.isDeploymentId=function isDeploymentId(entityId){return esw.getKeyPrefix(entityId)==="572";};LiveAgentAPI.prototype.sendFileInfo=function sendFileInfo(data){var event=document.createEvent("CustomEvent");event.initCustomEvent("sendFileInfo",true,false,{name:data.name,size:data.size});window.dispatchEvent(event);};LiveAgentAPI.prototype.getSessionId=function getSessionId(){return this.sid;};esw.liveAgentAPI=new LiveAgentAPI();});